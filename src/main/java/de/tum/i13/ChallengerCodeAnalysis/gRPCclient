public class Main {
    public static void main(String[] args) {
        setPrefix("GRPC-");
        System.out.println("Starting grpc benchmark with "+args[0]);
        ManagedChannel channel = ManagedChannelBuilder
                //.forAddress("challenge.msrg.in.tum.de", 5023)
                .forAddress("127.0.0.1", 5023) //in case it is used internally
                .usePlaintext()
                .build();
        var challengeClient = ChallengerGrpc.newBlockingStub(channel) //for demo, we show the blocking stub
                .withMaxInboundMessageSize(100 * 1024 * 1024)
                .withMaxOutboundMessageSize(100 * 1024 * 1024)
        BenchmarkConfiguration bc = BenchmarkConfiguration.newBuilder()
                .setBenchmarkName("Testrun " + new Date().toString())
                .addQueries(Query.Q1)
                .addQueries(Query.Q2)
//                .setToken("vctmqcboxqbnbwulepbtcypwnwgmwmyg") //mongoDB
                .setToken(args[0]) //PSQL
                .setBenchmarkType("evaluation") //Benchmark Type for evaluation
                .build();
        Benchmark newBenchmark = challengeClient.createNewBenchmark(bc);
        challengeClient.startBenchmark(newBenchmark);
        while(true) {
            Batch batch = challengeClient.nextBatch(newBenchmark);

            if (batch.getLast()) { //Stop when we get the last batch
                break;
            }
            var q1Results = calculateOutliers(batch);
            ResultQ1 q1Result = ResultQ1.newBuilder()
                    .setBenchmarkId(newBenchmark.getId()) //set the benchmark id
                    .setBatchSeqId(batch.getSeqId()) //set the sequence number
                    .addAllEntries(q1Results)
                    .build();
            challengeClient.resultQ1(q1Result);
            var centroidsOut = calculateCentroidsOut(batch);
            var centroidsIn = calculateCentroidsIn(batch);
            ResultQ2 q2Result = ResultQ2.newBuilder()
                    .setBenchmarkId(newBenchmark.getId()) //set the benchmark id
                    .setBatchSeqId(batch.getSeqId()) //set the sequence number
                    .addAllCentroidsIn(centroidsIn)
                    .addAllCentroidsOut(centroidsOut)
                    .build();
            challengeClient.resultQ2(q2Result);
        }
        challengeClient.endBenchmark(newBenchmark);
        channel.shutdown();
    }
